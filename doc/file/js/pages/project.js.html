<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">js/pages/project.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/nahidakbar/janus" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">common</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-event">event</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-pageview">pageview</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Create">Create</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Delete">Delete</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Read">Read</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Update">Update</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-request">request</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">pages</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-dropbox">dropbox</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-github">github</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-index">index</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-localstorage">localstorage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-project">project</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">projects</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/projects/GitHub.js~Github.html">Github</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/projects/LocalStorage.js~LocalStorage.html">LocalStorage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/projects/Storage.js~Storage.html">Storage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-add">add</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get">get</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-list">list</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">types/md</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-edit">edit</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-view">view</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-name">name</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-templates">templates</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">js/pages/project.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * Janus Copyright (C) 2017 Nahid Akbar
 */

&quot;use strict&quot;;

const projects = require(&apos;projects&apos;);
const types = require(&apos;types&apos;);
const pluralise = require(&apos;pluralize&apos;);
const naturalSort = require(&apos;javascript-natural-sort&apos;);

import * as analytics from &quot;common/analytics&quot;;

export default function(context)
{
  context.head.text(context.State(&apos;name&apos;).toUncamelCase());
  showFolder(context, projects.get(context.State(&apos;name&apos;)), context.State(&apos;folder&apos;));
};

function showFolder(context, project, folder)
{
  project.listFolder(folder).then(list =&gt;
  {
    let parent = context.body.clear();
    if (folder)
    {
      parent.H2(folder);
    }
    Object.keys(list).sort(naturalSort).forEach(key =&gt;
    {
      let item = list[key]
      showFile(context, parent.Div(), project, folder, item);
    });
    
    newFile(context, parent.Div().Class(&apos;noprint&apos;), project, folder);
  });
}

function newFile(context, parent, project, folder)
{
  parent.H2(&apos;Create New File&apos;);
  parent.Label(&apos;Name: &apos;).Display(&apos;block&apos;);
  let nameInput = parent.Text().Pattern(&apos;^[A-Za-z0-9\-_]+$&apos;).Display(&apos;block&apos;);
  parent.Label(&apos;Type: &apos;).Display(&apos;block&apos;);
  let typeInput = parent.Select().Options(getTypes()).Display(&apos;block&apos;);
  parent.Label(&apos;Template: &apos;).Display(&apos;block&apos;);
  let templateInput = parent.Select().Options(getTypeDefaults(typeInput.Value())).Display(&apos;block&apos;);
  typeInput.OnChange(() =&gt;
  {
    analytics.event(typeInput.Value(), &apos;select&apos;);
    templateInput.Options(getTypeDefaults(typeInput.Value()));
  });
  templateInput.OnChange(() =&gt;
  {
    analytics.event(typeInput.Value(), &apos;select&apos;, templateInput.Value());
  });
  parent.Button(&apos;Create&apos;).OnClick(() =&gt;
  {
    let name = nameInput.Value();
    let type = typeInput.Value();
    let template = templateInput.Value();
    analytics.event(type, &apos;create&apos;, template);
    if (name &amp;&amp; nameInput.Validity().valid)
    {
      project.setFile(folder, project.makeKey(name, type), types[type].templates[template])
        .then(() =&gt;
      {
        analytics.event(type, &apos;create-success&apos;, template);
        showFolder(context, project, folder)
      });
    }
  }).Display(&apos;block&apos;);
}

function showFile(context, section, project, folder, item)
{
  section.H1(item.name.toUncamelCase());
  let itemContainer = section.Div().Class(&apos;item&apos;);
  let itemContent = itemContainer.Div().Class(&apos;content&apos;);
  let itemToolbar = itemContainer.Div().Class(&apos;toolbar&apos;);
  let module = types[item.module];
  itemContent.Loader();
  project.getFile(folder, item.key).then(contents =&gt;
  {
    module.view(itemContent.clear(), item, contents);
    itemToolbar.Button(&apos;Rename&apos;).OnClick(() =&gt;
    {
      analytics.event(item.module, &apos;rename&apos;, &apos;attempt&apos;);
      let newName = prompt(`Please enter a new name for ${item.name}`, item.name);
      if (newName)
      {
        newName = newName.replace(/[^A-Z0-9a-z\-_]/g, &apos;&apos;);
        if (newName &amp;&amp; newName !== item.name)
        {
          let newKey = project.makeKey(newName, item.module);
          project.renameFile(folder, item.key, newKey)
            .then(() =&gt;
            {
              analytics.event(item.module, &apos;rename&apos;, &apos;success&apos;);
              item.key = newKey;
              showFolder(context, project, folder);
            }, err =&gt;
            {
              alert(err);
              analytics.event(item.module, &apos;rename&apos;, &apos;failure&apos;);
            });
        }
      }
    });
    itemToolbar.Button(&apos;Edit&apos;).OnClick(() =&gt;
    {
      analytics.event(item.module, &apos;edit&apos;);
      itemToolbar.Display(&apos;none&apos;);
      let editContainer = itemContent.clear().Div();
      let changed = item;
      types[item.module].edit(editContainer, item, contents, update =&gt;
      {
        changed = update;
      });  
      let editToolbar = itemContent.Div();
      editToolbar.Button(&apos;Save&apos;).OnClick(() =&gt;
      {
        analytics.event(item.module, &apos;save&apos;, &apos;attempt&apos;);
        project.setFile(folder, item.key, changed).then(() =&gt;
        {
          alert(&apos;Saved&apos;);
          contents = changed;
          analytics.event(item.module, &apos;save&apos;, &apos;success&apos;);
        }, err =&gt;
        {
          alert(err);
          analytics.event(item.module, &apos;save&apos;, &apos;failure&apos;);
        });
      });
      editToolbar.Button(&apos;Done&apos;).OnClick(() =&gt;
      {
        itemToolbar.Display(&apos;&apos;);
        if (JSON.stringify(contents) !== JSON.stringify(changed) &amp;&amp; confirm(&quot;Save changes?&quot;))
        {
          analytics.event(item.module, &apos;done&apos;, &apos;attempt&apos;);
          project.setFile(folder, item.key, changed).then(() =&gt;
          {
            analytics.event(item.module, &apos;done&apos;, &apos;success&apos;);
            contents = changed;
            module.view(itemContent.clear(), item, contents);
          }, err =&gt;
          {
            analytics.event(item.module, &apos;done&apos;, &apos;failure&apos;);
          });
        }
        else
        {
          analytics.event(item.module, &apos;done&apos;, &apos;nochange&apos;);
          module.view(itemContent.clear(), item, contents);
        }
      });
    });
    itemToolbar.Button(&apos;Delete&apos;).OnClick(() =&gt;
    {
      analytics.event(item.module, &apos;delete&apos;, &apos;click&apos;);
      if (confirm(`Are you sure you want to delete ${item.name}?`))
      {
        analytics.event(item.module, &apos;delete&apos;, &apos;attempt&apos;);
        project.deleteFile(folder, item.key)
          .then(() =&gt;
        {
          analytics.event(item.module, &apos;delete&apos;, &apos;success&apos;);
          showFolder(context, project, folder);
        }, err =&gt;
        {
          analytics.event(item.module, &apos;delete&apos;, &apos;failure&apos;);
          alert(err);
        });
      }
      else
      {
        analytics.event(item.module, &apos;delete&apos;, &apos;cancel&apos;);
      }
    });
  });
}

function getTypes()
{
  let output = {};
  Object.keys(types).forEach(type =&gt; output[type] = types[type].name);
  return output;
}

function getTypeDefaults(type)
{
  let output = {};
  Object.keys(types[type].templates).forEach(template =&gt; output[template] = template.toUncamelCase());
  return output;
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
